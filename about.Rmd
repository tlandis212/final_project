---
title: "About"
author: "Teddy Landis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(gt)
library(lubridate)

# I didn't include the dataset in my repository because the file are too large.
# Information on how to download my datasets can be found in my README.md. In a
# Piazza post, it was suggested this was a viable alternative to using GitHub
# LFS.

# Load in both datasets

alamance_hist <- read.delim("raw_data/ncvhis1.txt")
alamance_reg <- read.delim("raw_data/ncvoter1.txt")

# Use full join to merge both datasets

alamance_full_voter <- full_join(alamance_hist, alamance_reg, by=c("voter_reg_num"))
```

For my project, I am looking at the effect first-time voting type has on future voting behaviors. If someone's first possible vote (i.e. the first possible election they can vote in after they turn 18), is cast through an absentee ballot, does that affect their likelihood of voting in future elections?

My data comes from two datasets provided by the [North Carolina Secretary of State](https://www.ncsbe.gov/Public-Records-Data-Info/Election-Results-Data) . I am using data from North Carolina because they provide both voter registration records and voter history for free on their website. I will design my project using the datasets for Alamance county, but once my project is built I will use the Statewide datasets. The statewide dataset is very large and slows my computer - I would rather wait until the end of my project to use it. Instructions on how to access this data are available in README.

Dataset 1 is alamance_hist (ncvhis1.txt). It is a .txt file that I downloaded from the North Carolina Secretary of State. It contains records for each vote cast. Dataset 2 is almanace_reg (ncvoter1.txt) and it contains each voter's voter registration record. Both contain a "voter registration number" which I can use to merge the datasets. The statewide datasets are identical but include more observations.

My repository can be found [here](https://github.com/tlandis212/final_project).

*Milestone 4 Update*: I further cleaned up my datafile. It is now smaller and only includes essential variables.

My plan is to create topline descriptions of how many people voted in each election after the previous one.

## Exploring the Dataset

```{r summary, echo = FALSE}

# I checked to see what types of voting methods there were. Everything that
# isn't "Absentee by Mail" requires an in-person vote.

alamance_full_voter%>% 
  group_by(voting_method) %>% 
  summarize(count = n()) %>% 
  gt()

```
## Milestone 5

```{r turnout, echo = FALSE}
# Find a list of all elections and their turnout. Due to the high number of
# extremely low turn out local elections, I am limiting this to the top 15. I
# filtered out missing values for election_desc as this filters out voters who
# have never cast a ballot.

turnout <- alamance_full_voter %>% 
  mutate(election_lbl = mdy(election_lbl)) %>% 
  filter(!is.na(election_desc)) %>% 
  count(election_lbl, election_desc) %>% 
  arrange(desc(n)) %>% 
  slice(1:15)

# I plotted turnout for each election, sorted in descending order of turnout. I
# used coord_flip() so the full election names can be shown. Because I'm using
# the count variable from my tibble (rather than doing it through geom_bar()), I
# needed to set stat = "identity".

ggplot(turnout, aes(reorder(election_desc, -n), n)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  theme_classic() +
  labs(title = "Turnout in Alamance, NC by Election", subtitle = "Number of Raw Votes Cast", caption = "Data Source: NC Secretary of State", x = "Election", y = "Votes Cast")
```
  
```{r small_dataset, echo = FALSE }
# Reduce the number of variables by eliminating unwanted variables and filter to
# create our dataset. As a reminder, we want an overall dataset that only
# contains voters who voted for the first time in 2012. We will be creating a
# control group (voted in person or one-stop absentee in 2012) and a treatment
# group (voted absentee in 2012)

alamance_small <- alamance_full_voter %>% 
  select(county_id.x:election_lbl, voting_method:voted_party_cd, status_cd:absent_ind, birth_year, birth_state) %>% 
  
  # Voters born in 1994 will have turned 18 in 2012
  
  filter(birth_year >= 1994) %>% 
  
  # Create a variable which contains the election, but as a string rather than a
  # date. This is so that we can cast these into variables later when we make
  # our data wider. I'm only relabeling for three elections, since I'm going to
  # filter our dataset to only include these three elections
  
  mutate(election = recode_factor(election_lbl, `11/06/2012` = "gelection_2012",
                `11/04/2014` = "gelection_2014",
                `11/08/2016` = "gelection_2016")) %>% 
  
  filter(election == "gelection_2012" | election == "gelection_2014" | election == "gelection_2016") %>% 

  # Create a dummy variable that signifies if a vote was cast by a mail-in
  # absentee ballot. NC offers several type of absentee voting, but we're only
  # interested in mail-in absentees. All other forms of absentee voting requires
  # in-person precense and we will count this as an in-person vote

  mutate(absentee = ifelse(voting_method == "ABSENTEE BY MAIL", "Absentee", "Not Absentee")) %>% 
  
  # Select the only variables we need now
  
  select(county_id.x:county_desc.x, voter_reg_num, election, absentee) %>% 
  
  # Create a variable for each of the elections and make the value equal to
  # "Absentee", "Not Absentee", "No Vote"
  
  pivot_wider(names_from = election, values_from = absentee, values_fill = list(absentee = "No Vote")) %>% 
  
  # Only include voters who voted in the 2012 election
  filter(gelection_2012 != "No Vote") %>% 
  arrange(voter_reg_num)
```

## Milestone 6

```{r ms6, echo = FALSE}

# Use alamance_small for Milestone 6. 

# Identify voters as part of the control or treatment group

ms_six_b <- alamance_small %>% 
  mutate(treatment = ifelse(gelection_2012 == "Absentee", "Absentee", "In Person/Early Vote"),
         outcome_2014 = ifelse(gelection_2014 != "No Vote", "Vote", "No vote"),
         outcome_2016 = ifelse(gelection_2016 != "No Vote", "Vote", "No vote"))
```

```{r}
# Play around with aes() in the ggplot with combinations of outcome_2014 and treatment. 
  # Count of XX Year total votes divided by count of treatment votes

    ggplot(ms_six_b, aes(x = treatment)) + 
  geom_bar(aes(y = (..count..)/(..count..)), fill = "red") +
    scale_y_continuous(labels=scales::percent) +
   theme_classic() +
  labs(x = "Voting Method",
       y = "Percent of Voters",
       title = "Voting in the 2012 General Election",
       subtitle = "18-year-old Voters from Alamance County, NC")
```
```{r}
ms_six <- ms_six_b %>% 
  mutate(treatment_2014 = ifelse(treatment == "Absentee" & gelection_2014 != "No Vote", TRUE, FALSE),
         control_2014 = ifelse(treatment == "In Person/Early Vote" & gelection_2014 != "No Vote", TRUE, FALSE))
  
ms_six %>% 
  count(control_2014)

count_voted_2012 <- ms_six %>% 
  filter(treatment == "Absentee") %>%
  count() %>% 
  pull()

count_voted_2014 <- ms_six %>% 
  filter(treatment_2014 == "TRUE") %>% 
  count() %>% 
  pull()
  
treatment_2014_x <- count_voted_2014 / count_voted_2012

count_voted_2012_control <- ms_six %>% 
  filter(treatment == "In Person/Early Vote") %>%
  count() %>% 
  pull()

count_voted_2014_control <- ms_six %>% 
  filter(control_2014 == "TRUE") %>% 
  count() %>% 
  pull()

control_2014_x <- count_voted_2014_control / count_voted_2012_control
```

```{r}
ggplot(ms_six, aes(x = outcome_2014, fill = treatment)) + 
  geom_bar(aes(y = (control_2014_x)/(..count..))) +
  scale_y_continuous(labels=scales::percent) +
  theme_classic() +
  labs(x = "Voting Method",
       y = "Percent of Voters",
       title = "Voting Method in the 2014 General Election",
       subtitle = "20-year-old Voters from Alamance County, NC")
```

```{r}
ggplot(ms_six, aes(x = gelection_2016, fill = treatment)) + 
  geom_bar(aes(y = (..count..)/sum(..count..))) +
  scale_y_continuous(labels=scales::percent) +
  geom_text(aes( label = scales::percent((..count..)/sum(..count..)),
  y= (..count..)/sum(..count..)), stat= "count", vjust = .5) +
  theme_classic() +
  labs(x = "Voting Method",
       y = "Percent of Voters",
       title = "Voting Method in the 2016 General Election",
       subtitle = "22-year-old Voters from Alamance County, NC",
       fill = "Voted Absentee in\n2012 General Election")
```

